#!/bin/bash

set -e

HOSTNAME=$1
FILENAME=$2

if [ -f ${FILENAME} ]; then
  PRIVATE_KEY=$(cat ${FILENAME} | base64)
  export GIT_SSH_KEY_GITLAB="${PRIVATE_KEY}"
  export GIT_SSH_HOST_GITLAB=${HOSTNAME}
fi

npm install -g git-ssh-key
git-ssh-key setup

SSH_FILENAME="$(echo ${HOSTNAME} | tr . _)_key"
$(echo "${GIT_SSH_KEY_GITLAB}" | base64 --decode) > ~/.ssh/git_ssh_keys/${SSH_FILENAME}
cat ~/.ssh/git_ssh_keys/${SSH_FILENAME}
ssh-keyscan ${HOSTNAME} >> ~/.ssh/known_hosts
