#!/bin/bash

set -e

HOSTNAME=$1
FILENAME=$2

if [ -f ${FILENAME} ]; then
  PRIVATE_KEY=$(cat ${FILENAME} | base64)
  cat ${FILENAME} >>~/.ssh/id_rsa
  export GIT_SSH_KEY_GITLAB="${PRIVATE_KEY}"
  export GIT_SSH_HOST_GITLAB=${HOSTNAME}
fi

if [ ! -d ~/.ssh ]; then
  mkdir -p ~/.ssh
fi

cat <<EOF >~/.ssh/config
Host git.nativecode.net
  IdentitiesOnly yes
  UserKnownHostsFile=/dev/null
  StrictHostKeyChecking no
  IdentityFile ~/.ssh/id_rsa
EOF

ssh-keyscan -H ${HOSTNAME} >>~/.ssh/known_hosts
